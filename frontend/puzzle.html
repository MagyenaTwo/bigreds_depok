<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Puzzle Liverpool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #c8102e;
      color: white;
      text-align: center;
    }
    h1 { margin-top: 20px; }
   #puzzleBoard {
  width: 90vw;              /* responsif */
  max-width: 450px;         /* batas maksimum */
  aspect-ratio: 1 / 1;      /* selalu kotak */
  margin: 20px auto;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(5, 1fr);
  gap: 2px;
  border: 4px solid white;
}

   
.piece {
  width: 100%;
  height: 100%;
  background-size: 100% 100%;   /* otomatis penuh sesuai board */
  border: 1px solid #fff;
  cursor: grab;
  transition: all 0.3s ease;
  position: relative;
  touch-action: none;
  user-select: none;
}

    .piece.dragging {
      opacity: 0.6;
      z-index: 10;
    }
    #info {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
    }
    #message {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background: gold;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: orange;
    }
     #claimPointsModal .modal-content {
    background: #fff;            /* latar putih */
    color: #212529;              /* teks gelap */
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  #claimPointsModal h5 {
    font-weight: bold;
    color: #28a745;              /* hijau selaras tombol */
  }

  #claimPointsModal p {
    margin: 10px 0 20px;
    font-size: 1rem;
  }

  #claimPointsModal .form-control {
    border-radius: 8px;
  }

  #claimPointsModal .btn-success {
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 500;
  }
  </style>
</head>
<body>
  <h1>üß© Puzzle Liverpool</h1>
  <p>Susun potongan gambar sebelum waktu habis!</p>
  
  <div id="info">
    ‚è±Ô∏è Waktu: <span id="timer">30</span> detik
  </div>
  
  <div id="puzzleBoard"></div>
  <div id="message"></div>
  
  <button onclick="newGame()">Ganti Gambar</button>

  <div class="modal fade" id="claimPointsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5>üéâ Selamat!</h5>
        <p>Kamu berhasil menyelesaikan puzzle. Klaim poin sekarang?</p>
        <input type="text" id="playerName" class="form-control mb-3" placeholder="Masukkan Nama" required>
        <button class="btn btn-success" onclick="claimPoints()">Klaim 10 Poin</button>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const board = document.getElementById("puzzleBoard");
  const size = 5;
  let pieces = [];
  let dragged;
  let timer;
  let timeLeft = 90;
  let imageUrl = "";

  async function loadImage() {
    try {
      const res = await fetch("/api/puzzle_images");
      const data = await res.json();
      if (!data.length) throw "Belum ada gambar tersedia!";
      const randomImg = data[Math.floor(Math.random() * data.length)];
      return randomImg.image_url;
    } catch {
      return "";
    }
  }

  async function newGame(resetTimer = false) {
    if (resetTimer) {
      clearInterval(timer);
      document.getElementById("message").innerText = "";
      document.getElementById("timer").innerText = "90";
      timeLeft = 90;
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timer);
          board.innerHTML = "";
          document.getElementById("message").innerHTML = `
            ‚è≥ Waktu habis! <br>
            <button class="btn btn-warning mt-3" onclick="newGame(true)">üîÑ Coba Lagi</button>
          `;
        }
      }, 1000);
    }
    imageUrl = await loadImage();
    if (!imageUrl) {
      document.getElementById("message").innerText = "‚ùå Tidak ada gambar untuk puzzle!";
      return;
    }
    createPuzzle(imageUrl);
  }

  function createPuzzle(img) {
  board.innerHTML = "";
  pieces = [];
  const boardSize = board.clientWidth;   // üî• ambil ukuran board yang sebenarnya
  for (let row = 0; row < size; row++) {
    for (let col = 0; col < size; col++) {
      const piece = document.createElement("div");
      piece.classList.add("piece");
      piece.style.backgroundImage = `url('${img}')`;
      piece.style.backgroundSize = `${boardSize}px ${boardSize}px`;  // sesuai board
      piece.style.backgroundPosition = `${-col * (boardSize / size)}px ${-row * (boardSize / size)}px`;
      piece.dataset.correct = `${row}-${col}`;
      piece.setAttribute("draggable", true);
      pieces.push(piece);
    }
  }
  shuffle();
}


  function shuffle() {
    board.innerHTML = "";
    pieces.sort(() => Math.random() - 0.5);
    pieces.forEach((p, idx) => {
      p.dataset.index = idx;
      board.appendChild(p);
    });
  }

  // ===== Desktop (drag & drop) =====
  document.addEventListener("dragstart", e => {
    if (e.target.classList.contains("piece")) {
      dragged = e.target;
      e.target.style.opacity = "0.6";
    }
  });

  document.addEventListener("dragend", e => {
    if (e.target.classList.contains("piece")) {
      e.target.style.opacity = "1";
    }
  });

  document.addEventListener("dragover", e => e.preventDefault());

  document.addEventListener("drop", e => {
    if (!e.target.classList.contains("piece")) return;
    swapPieces(dragged, e.target);
  });

  // ===== Mobile (touch events) =====
  document.addEventListener("touchstart", e => {
    if (e.target.classList.contains("piece")) {
      dragged = e.target;
    }
  });

  document.addEventListener("touchend", e => {
    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    if (target && target.classList.contains("piece")) {
      swapPieces(dragged, target);
    }
  });

  // ===== Swap function (untuk desktop & mobile) =====
  function swapPieces(a, b) {
    const draggedIndex = a.dataset.index;
    const targetIndex = b.dataset.index;
    [pieces[draggedIndex], pieces[targetIndex]] = [pieces[targetIndex], pieces[draggedIndex]];
    board.innerHTML = "";
    pieces.forEach((p, idx) => {
      p.dataset.index = idx;
      board.appendChild(p);
    });
    checkWin();
  }

  function checkWin() {
    const children = [...board.children];
    const correct = children.every((piece, idx) => {
      const row = Math.floor(idx / size);
      const col = idx % size;
      return piece.dataset.correct === `${row}-${col}`;
    });
    if (correct) {
      clearInterval(timer);
      document.getElementById("message").innerText = "üéâ Selamat! Puzzle selesai sebelum waktu habis!";
      const modalElement = document.getElementById('claimPointsModal');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
      modalElement.addEventListener('hidden.bs.modal', () => location.reload());
    }
  }

  function claimPoints() {
    const name = document.getElementById("playerName").value;
    if (!name) return alert("Isi nama dulu!");
    fetch("/api/claim_puzzle_point", {
      method: "POST",
      body: new URLSearchParams({ full_name: name })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message + " Total poin: " + data.total_points);
      const modal = bootstrap.Modal.getInstance(document.getElementById('claimPointsModal'));
      modal.hide();
      document.getElementById("playerName").value = "";
    })
    .catch(err => console.error(err));
  }
  board.addEventListener("touchmove", e => {
  e.preventDefault(); // cegah scroll saat geser puzzle
}, { passive: false });


  newGame(true);
</script>

</body>
</html>
