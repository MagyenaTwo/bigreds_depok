{% extends "base.html" %}

{% block title %}CMS Merchandise - Bigreds Depok{% endblock %}

{% block content %}
<h1>CMS Merchandise</h1>

<!-- Upload Form -->
<form id="merchForm" method="post" action="/merchandise/" class="upload-form" 
      style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
  <h2 style="margin-bottom: 15px;">Tambah Merchandise</h2>

  <label for="name">Nama Barang</label><br>
  <input type="text" id="name" name="name" required style="width: 100%; margin-bottom: 10px;"><br>

  <label for="description">Deskripsi</label><br>
  <textarea id="description" name="description" rows="3" 
            style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;"></textarea><br>

            <label for="price_display">Harga</label><br>
<div style="display:flex; align-items:center; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; overflow:hidden;">
  <span style="background:#f3f4f6; padding:10px; font-weight:bold;">Rp</span>
  <input type="text" id="price_display" placeholder="0,00" 
         style="flex:1; border:none; padding:10px; outline:none;">
</div>
<input type="hidden" id="price" name="price">

  <label for="stock">Stok</label><br>
  <input type="number" id="stock" name="stock" value="0" 
         style="width: 100%; margin-bottom: 10px;"><br>
  

<label for="images">Pilih Gambar</label><br>
<input type="file" id="images" name="images" accept="image/*" multiple required 
       style="margin-bottom: 10px;"><br>


  <button type="submit">+ Tambah Merchandise</button>
</form>

<!-- Toolbar atas: search + total item -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
  <!-- Input pencarian -->
  <div style="position: relative; flex: 1; max-width: 280px;">
    <input
      type="text"
      id="searchInput"
      placeholder="Cari merchandise..."
      onkeyup="filterTable()"
      style="
        width: 100%;
        padding: 10px 36px 10px 14px;
        font-size: 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background-color: #f9fafb;
        color: #111827;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
      "
    >
    <span
      id="clearSearch"
      onclick="clearSearch()"
      style="
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        color: #6b7280;
        cursor: pointer;
        display: none;
        user-select: none;
      "
    >√ó</span>
  </div>

  <!-- Total item -->
  <div style="font-weight: bold; font-size: 15px; display: flex; flex-direction: column; align-items: flex-end;">
    <div><span style="font-size: 18px;">üõí</span> Total Merchandise: <span id="totalCount">0</span></div>
  </div>
</div>

<!-- Merchandise List -->
<div class="table-container">
  <table class="styled-table" id="merchTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Harga</th>
        <th>Stok</th>
        <th>Gambar</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="merchList">
      <!-- isi dari JS -->
    </tbody>
  </table>
</div>

<!-- Modal Konfirmasi Hapus -->
<div id="deleteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:300px; text-align:center;">
    <p>Yakin ingin menghapus merchandise ini?</p>
    <div style="margin-top:15px;">
      <button id="confirmDeleteBtn" style="background:#e53935;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;">
        Hapus
      </button>
      <button onclick="closeDeleteModal()" style="background:#ccc;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;">
        Batal
      </button>
    </div>
  </div>
</div>
<script>
let selectedDeleteId = null;

function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const clearBtn = document.getElementById("clearSearch");
  const tableRows = document.querySelectorAll("#merchTable tbody tr");

  clearBtn.style.display = filter ? "block" : "none";

  tableRows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(filter) ? "" : "none";
  });
}

function clearSearch() {
  const input = document.getElementById("searchInput");
  input.value = "";
  filterTable();
}

function showDeleteConfirm(id) {
  selectedDeleteId = id;
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
  selectedDeleteId = null;
  document.getElementById('deleteModal').style.display = 'none';
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
  if (selectedDeleteId) {
    fetch(`/merchandise/${selectedDeleteId}`, { method: "DELETE" })
      .then(() => {
        loadMerchandise();
        closeDeleteModal();
        showToast("‚úÖ Merchandise berhasil dihapus");
      })
      .catch(() => showToast("‚ùå Gagal menghapus merchandise", true));
  }
});
function loadMerchandise() {
  fetch("/merchandise/")
    .then(res => res.json())
    .then(data => {
      const merchList = document.getElementById("merchList");
      merchList.innerHTML = "";
      document.getElementById("totalCount").textContent = data.length;

      data.forEach((item, index) => {
        let links = "";
        if (item.image_url) {
          links = item.image_url.split(",").map(url => {
            return `<a href="${url.trim()}" target="_blank">Lihat</a>`;
          }).join(" | ");
        }

        merchList.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${item.name}</td>
            <td>Rp ${parseFloat(item.price).toLocaleString()}</td>
            <td>${item.stock}</td>
            <td>${links}</td>
            <td>
              <button type="button" onclick="showDeleteConfirm(${item.id})" 
                      style="background:transparent;border:none;color:#e53935;font-size:18px;cursor:pointer;">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `;
      });
    });
}


document.getElementById("merchForm").addEventListener("submit", e => {
  e.preventDefault();
  const form = e.target;
  const submitBtn = form.querySelector("button[type=submit]");
  submitBtn.disabled = true;
  const oldText = submitBtn.textContent;
  submitBtn.textContent = "‚è≥ Menyimpan...";
  const formData = new FormData(form);

  fetch("/merchandise/", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast("‚ùå " + data.error, true);
      } else {
        showToast("‚úÖ Merchandise berhasil ditambahkan");
        setTimeout(() => window.location.href = "/cms/merchandise", 1200);
      }
    })
    .catch(() => showToast("‚ùå Terjadi kesalahan", true))
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = oldText;
    });
});

document.addEventListener("DOMContentLoaded", loadMerchandise);

function showToast(message, isError = false) {
  let toast = document.createElement("div");
  toast.textContent = message;
  toast.style.position = "fixed";
  toast.style.top = "20px";
  toast.style.right = "20px";
  toast.style.background = isError ? "#e53935" : "#4caf50";
  toast.style.color = "white";
  toast.style.padding = "10px 16px";
  toast.style.borderRadius = "6px";
  toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  toast.style.zIndex = "9999";
  toast.style.opacity = "0";
  toast.style.transition = "opacity 0.3s ease";
  document.body.appendChild(toast);
  requestAnimationFrame(() => toast.style.opacity = "1");
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

const priceDisplay = document.getElementById("price_display");
const priceHidden = document.getElementById("price");

priceDisplay.addEventListener("input", function() {
  let value = this.value.replace(/\D/g, "");
  if (!value) {
    this.value = "";
    priceHidden.value = "";
    return;
  }

  let floatValue = parseFloat(value) / 100; // angka asli untuk backend
  priceHidden.value = floatValue;

  this.value = new Intl.NumberFormat("id-ID", { 
    minimumFractionDigits: 2, 
    maximumFractionDigits: 2 
  }).format(floatValue);
});
</script>

{% endblock %}
